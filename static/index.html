<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스크립트 스케줄러</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .job-card {
            transition: all 0.3s ease;
        }
        .job-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand mb-0 h1">스크립트 스케줄러</span>
            <button class="btn btn-outline-light" onclick="showLogs()">
                <i class="bi bi-journal-text"></i> 로그 보기
            </button>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- 작업 추가 폼 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">새 작업 추가</h5>
                    </div>
                    <div class="card-body">
                        <form id="jobForm">
                            <div class="mb-3">
                                <label for="jobId" class="form-label">작업 ID</label>
                                <input type="text" class="form-control" id="jobId" required>
                            </div>
                            <div class="mb-3">
                                <label for="scriptPath" class="form-label">실행 파일 경로</label>
                                <input type="text" class="form-control" id="scriptPath" 
                                       placeholder="예: crawler/run_crawler.sh" required>
                            </div>
                            <div class="mb-3">
                                <label for="intervalValue" class="form-label">실행 간격</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="intervalValue" 
                                           min="1" required>
                                    <select class="form-select" id="intervalUnit">
                                        <option value="seconds">초</option>
                                        <option value="minutes">분</option>
                                        <option value="hours">시간</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100" onclick="createJob()">
                                <i class="bi bi-plus-circle me-2"></i>작업 추가
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 작업 목록 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">등록된 작업 목록</h5>
                        <button class="btn btn-sm btn-light" onclick="loadJobs()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="jobList" class="row g-3">
                            <!-- 작업 목록이 여기에 동적으로 추가됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 작업 수정 모달 -->
    <div class="modal fade" id="editJobModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">작업 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editJobForm">
                        <input type="hidden" id="editJobId">
                        <div class="mb-3">
                            <label for="editScriptPath" class="form-label">실행 파일 경로</label>
                            <input type="text" class="form-control" id="editScriptPath" required>
                        </div>
                        <div class="mb-3">
                            <label for="editIntervalValue" class="form-label">실행 간격</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editIntervalValue" min="1" required>
                                <select class="form-select" id="editIntervalUnit">
                                    <option value="seconds">초</option>
                                    <option value="minutes">분</option>
                                    <option value="hours">시간</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="updateJob()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 로그 보기 모달 -->
    <div class="modal fade" id="logModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">스케줄러 로그</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-sm btn-primary" onclick="refreshLogs()">
                            <i class="bi bi-arrow-clockwise"></i> 새로고침
                        </button>
                    </div>
                    <pre id="logContent" class="bg-light p-3" style="max-height: 500px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>
    </div>
    

    <!-- 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // loadJobs 함수 수정 - 작업 카드 HTML 변경
        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                const jobs = await response.json();
                const jobList = document.getElementById('jobList');
                jobList.innerHTML = '';
                
                jobs.forEach(job => {
                    const jobElement = document.createElement('div');
                    jobElement.className = 'col-md-6';
                    jobElement.innerHTML = `
                        <div class="card job-card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-primary">${job.id}</h6>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-2"></i>다음 실행:
                                    </small><br>
                                    ${new Date(job.next_run_time).toLocaleString()}
                                </p>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="bi bi-arrow-repeat me-2"></i>실행 간격:
                                    </small><br>
                                    ${job.interval}
                                </p>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100">
                                    <button class="btn btn-primary btn-sm" onclick="editJob('${job.id}')">
                                        <i class="bi bi-pencil me-2"></i>수정
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteJob('${job.id}')">
                                        <i class="bi bi-trash me-2"></i>삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    jobList.appendChild(jobElement);
                });
            } catch (error) {
                console.error('Error:', error);
                showToast('작업 목록을 불러오는데 실패했습니다.', 'error');
            }
        }


        async function createJob() {
            const jobId = document.getElementById('jobId').value;
            const scriptPath = document.getElementById('scriptPath').value;
            const intervalValue = parseInt(document.getElementById('intervalValue').value);
            const intervalUnit = document.getElementById('intervalUnit').value;

            if (!jobId || !scriptPath || isNaN(intervalValue)) {
                alert('모든 필드를 올바르게 입력해주세요.');
                return;
            }

            if (!scriptPath.endsWith('.sh')) {
                alert('실행 파일은 .sh 파일이어야 합니다.');
                return;
            }

            if (intervalValue < 1) {
                alert('실행 간격은 1 이상이어야 합니다.');
                return;
            }

            const jobData = {
                job_id: jobId,
                script_path: scriptPath,
                interval_value: intervalValue,
                interval_unit: intervalUnit
            };

            try {
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jobData)
                });

                if (response.ok) {
                    document.getElementById('jobForm').reset();
                    await loadJobs();
                    showToast('작업이 성공적으로 추가되었습니다.', 'success');
                } else {
                    const error = await response.json();
                    showToast(`작업 추가 실패: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('작업 추가 중 오류가 발생했습니다.', 'error');
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('이 작업을 삭제하시겠습니까?')) return;

            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadJobs();
                    showToast('작업이 삭제되었습니다.', 'success');
                } else {
                    showToast('작업 삭제에 실패했습니다.', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('작업 삭제 중 오류가 발생했습니다.', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.createElement('div');
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = '20px';
            toastContainer.style.right = '20px';
            toastContainer.style.zIndex = '1050';

            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'}`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                document.body.removeChild(toastContainer);
            });
        }

        // 새로운 함수들 추가
        async function editJob(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                const job = await response.json();
                
                document.getElementById('editJobId').value = jobId;
                document.getElementById('editScriptPath').value = job.script_path;
                document.getElementById('editIntervalValue').value = job.interval_value;
                document.getElementById('editIntervalUnit').value = job.interval_unit;
                
                new bootstrap.Modal(document.getElementById('editJobModal')).show();
            } catch (error) {
                console.error('Error:', error);
                showToast('작업 정보를 불러오는데 실패했습니다.', 'error');
            }
        }

        async function updateJob() {
            const jobId = document.getElementById('editJobId').value;
            const scriptPath = document.getElementById('editScriptPath').value;
            const intervalValue = parseInt(document.getElementById('editIntervalValue').value);
            const intervalUnit = document.getElementById('editIntervalUnit').value;

            if (!scriptPath || isNaN(intervalValue)) {
                showToast('모든 필드를 올바르게 입력해주세요.', 'error');
                return;
            }

            const jobData = {
                script_path: scriptPath,
                interval_value: intervalValue,
                interval_unit: intervalUnit
            };

            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jobData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editJobModal')).hide();
                    await loadJobs();
                    showToast('작업이 성공적으로 수정되었습니다.', 'success');
                } else {
                    const error = await response.json();
                    showToast(`작업 수정 실패: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('작업 수정 중 오류가 발생했습니다.', 'error');
            }
        }

        async function showLogs() {
            await refreshLogs();
            new bootstrap.Modal(document.getElementById('logModal')).show();
        }

        async function refreshLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                document.getElementById('logContent').textContent = data.logs.join('');
            } catch (error) {
                console.error('Error:', error);
                showToast('로그를 불러오는데 실패했습니다.', 'error');
            }
        }
        // 페이지 로드 시 작업 목록 불러오기
        document.addEventListener('DOMContentLoaded', loadJobs);
    </script>
</body>
</html>
